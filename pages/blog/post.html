<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loading…</title>
    <link rel="stylesheet" href="../../css/style.css" />
    <style>
      .post-cover img {
        width: 100%;
        max-height: 400px;
        object-fit: cover;
        margin-bottom: 1.5rem;
        border-radius: 8px;
      }
      .post-title {
        font-size: 2rem;
        margin: 0.5rem 0;
      }
      .post-meta {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 2rem;
      }
      .post-body {
        line-height: 1.6;
        font-size: 1.05rem;
      }
    </style>
  </head>
  <body>
    <header class="post-header">
      <div class="post-cover" id="cover"></div>
      <h1 class="post-title" id="title"></h1>
      <p class="post-meta" id="meta"></p>
    </header>

    <main class="post-body" id="body">Loading…</main>

    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      async function loadPost() {
        const params = new URLSearchParams(window.location.search);
        const slug = params.get("slug");
        if (!slug) {
          document.getElementById("body").innerText = "No slug provided.";
          return;
        }

        try {
          // Load post index
          const res = await fetch("../../content/posts/posts.json");
          const posts = await res.json();
          const post = posts.find((p) => p.slug === slug);

          if (!post) {
            document.getElementById("body").innerText = "Post not found.";
            return;
          }

          // Fill in metadata
          document.title = post.title + " — NYMM";
          document.getElementById("title").innerText = post.title;
          document.getElementById("meta").innerText =
            new Date(post.date).toLocaleDateString() +
            (post.author ? " — by " + post.author : "");
          if (post.cover) {
            document.getElementById(
              "cover"
            ).innerHTML = `<img src="${post.cover}" alt="${post.title} cover">`;
          }

          // Fetch markdown file
          const mdRes = await fetch("../../content/posts/" + post.filename);
          const md = await mdRes.text();
          // Remove front-matter before parsing
          const body = md.replace(/^---[\s\S]*?---/, "").trim();
          document.getElementById("body").innerHTML = marked.parse(body);
        } catch (err) {
          console.error(err);
          document.getElementById("body").innerText = "Error loading post.";
        }
      }

      loadPost();
    </script>
  </body>
</html>
